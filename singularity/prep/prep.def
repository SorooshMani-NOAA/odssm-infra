BootStrap: docker
From: continuumio/miniconda3:24.3.0-0

%files
    environment.yml 
    files/*.py /scripts/
    files/refs/* /refs/

%environment
    export PYTHONPATH=/scripts

%post
    ENV_NAME=prep

    apt update && apt upgrade && apt install -y \
        git \
        libarchive

    conda install mamba -n base -c conda-forge 
    mamba update --name base --channel defaults conda 
    mamba env create -n $ENV_NAME --file /environment.yml

#    git clone https://github.com/noaa-ocs-modeling/ensembleperturbation
#    cd ensembleperturbation
#    git fetch origin pull/139/head:rmax
#    git checkout rmax
#    conda run -n $ENV_NAME --no-capture-output \
#        pip install ./
#    cd ..
#    rm -rf ensembleperturbation

    conda run -n $ENV_NAME --no-capture-output \
        pip install "pyschism>=0.1.15"
    conda run -n $ENV_NAME --no-capture-output \
        pip install "coupledmodeldriver>=1.6.6"
    conda run -n $ENV_NAME --no-capture-output \
        pip install stormevents==2.2.3
    conda run -n $ENV_NAME --no-capture-output \
        pip install "ensembleperturbation>=1.1.2"
    conda run -n $ENV_NAME --no-capture-output \
        pip uninstall -y pygeos geopandas  # We use shapely 2

    mamba install -y -n $ENV_NAME -cconda-forge \
        --force-reinstall geopandas geopandas-base

    git clone https://github.com/schism-dev/schism
    cp -v schism/src/Utility/Pre-Processing/STOFS-3D-Atl-shadow-VIMS/Pre_processing/Source_sink/Relocate/relocate_source_feeder.py /scripts
    cp -v schism/src/Utility/Pre-Processing/STOFS-3D-Atl-shadow-VIMS/Pre_processing/Source_sink/feeder_heads_bases_v2.1.xy /refs
#    cp -v schism/src/Utility/Pre-Processing/STOFS-3D-Atl-shadow-VIMS/Pre_processing/Source_sink/relocate_florence.reg /refs
    rm -rfv schism
    
    mamba clean --all --yes && apt remove -y git
    
    
%runscript
    conda run -n prep --no-capture-output python -m $*


%labels
    Author "Soroosh Mani"
